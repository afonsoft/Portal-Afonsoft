var PermissionsTree=function(e){return function(){var t;return{init:function(r){var n;(t=r).jstree({types:{default:{icon:"fa fa-folder kt--font-warning"},file:{icon:"fa fa-file kt--font-warning"}},checkbox:{keep_selected_style:!1,three_state:!1,cascade:""},search:{show_only_matches:!0},plugins:["checkbox","types","search"]}),t.on("changed.jstree",function(r,n){var s;n.node&&(n.node.state.selected?(function e(r){t.jstree("select_node",r,!0);var n=t.jstree("get_parent",r);n&&e(n)}(t.jstree("get_parent",n.node)),s=e.makeArray(t.jstree("get_node",n.node).children),t.jstree("select_node",s)):(s=e.makeArray(t.jstree("get_node",n.node).children),t.jstree("deselect_node",s)))}),n=!1,e("#PermissionTreeFilter").keyup(function(){n&&clearTimeout(n),n=setTimeout(function(){var r=e("#PermissionTreeFilter").val();t.jstree(!0)&&t.jstree(!0).search(r)},250)})},getSelectedPermissionNames:function(){for(var e=[],r=t.jstree("get_selected",!0),n=0;n<r.length;n++)e.push(r[n].id);return e}}}}(jQuery);
app.modals.PermissionTreeModal=function(){var e,o=null,n={onSelectionDone:function(){}};this.init=function(i){e=i,n=$.extend(n,e.getOptions().options),(o=new PermissionsTree).init(e.getModal().find("#PermissionFilterTree .permission-tree")),e.onBeforeClose(function(){"function"==typeof n.onSelectionDone&&n.onSelectionDone(o.getSelectedPermissionNames())})}},app.modals.PermissionTreeModal.create=function(e){return new app.ModalManager({viewUrl:abp.appPath+"App/Common/PermissionTreeModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/Common/Modals/_PermissionTreeModal.js",modalClass:"PermissionTreeModal",options:e,removeAllOnCloseBindsAfterModalClose:!0})};
var OrganizationTree=function(e){return function(){var t,n={cascadeSelectEnabled:!0};return{init:function(r,a){var c;a=e.extend(n,a),(t=r).jstree({types:{default:{icon:"fa fa-folder kt--font-warning"},file:{icon:"fa fa-file kt--font-warning"}},checkbox:{keep_selected_style:!1,three_state:!1,cascade:""},search:{show_only_matches:!0},plugins:["checkbox","types","search"]}),t.on("changed.jstree",function(n,r){var c;a.cascadeSelectEnabled&&r.node&&(r.node.state.selected?(function e(n){t.jstree("select_node",n,!0);var r=t.jstree("get_parent",n);r&&e(r)}(t.jstree("get_parent",r.node)),c=e.makeArray(t.jstree("get_node",r.node).children),t.jstree("select_node",c)):(c=e.makeArray(t.jstree("get_node",r.node).children),t.jstree("deselect_node",c)))}),c=!1,e("#OrganizationTreeFilter").keyup(function(){c&&clearTimeout(c),c=setTimeout(function(){var n=e("#OrganizationTreeFilter").val();t.jstree(!0).search(n)},250)})},getSelectedOrganizations:function(){for(var e=[],n=t.jstree("get_selected",!0),r=0;r<n.length;r++)e.push(n[r].id);return e}}}}(jQuery);
!function(e){app.modals.CreateOrEditUserModal=function(){var t,a,i=abp.services.app.user,o=null,s=new app.PasswordComplexityHelper;function n(){var a=[];return t.getModal().find(".user-role-checkbox-list input[type=checkbox]").each(function(){e(this).is(":checked")&&!e(this).is(":disabled")&&a.push(e(this).attr("name"))}),a}this.init=function(i){t=i,(a=new OrganizationTree).init(t.getModal().find(".organization-tree"),{cascadeSelectEnabled:!1}),(o=t.getModal().find("form[name=UserInformationsForm]")).validate();var r=t.getModal().find("input[name=Password],input[name=PasswordRepeat]"),d=r.closest(".form-group");s.setPasswordComplexityRules(r,window.passwordComplexitySetting),e("#EditUser_SetRandomPassword").change(function(){e(this).is(":checked")?(d.slideUp("fast"),t.getArgs().id||r.removeAttr("required")):(d.slideDown("fast"),t.getArgs().id||r.attr("required","required"))}),t.getModal().find(".user-role-checkbox-list input[type=checkbox]").change(function(){e("#assigned-role-count").text(n().length)}),t.getModal().find("[data-toggle=tooltip]").tooltip()},this.save=function(){if(o.valid()){var e=n(),s=o.serializeFormToObject();s.SetRandomPassword&&(s.Password=null),t.setBusy(!0),i.createOrUpdateUser({user:s,assignedRoleNames:e,sendActivationEmail:s.SendActivationEmail,SetRandomPassword:s.SetRandomPassword,organizationUnits:a.getSelectedOrganizations()}).done(function(){abp.notify.info(app.localize("SavedSuccessfully")),t.close(),abp.event.trigger("app.createOrEditUserModalSaved")}).always(function(){t.setBusy(!1)})}}}}(jQuery);
app.modals.UserPermissionsModal=function(){var e,s,i=abp.services.app.user;this.init=function(n){e=n,(s=new PermissionsTree).init(e.getModal().find(".permission-tree")),e.getModal().find("[data-toggle=tooltip]").tooltip(),e.getModal().find(".reset-permissions-button").click(function(){e.setBusy(!0),i.resetUserSpecificPermissions({id:e.getArgs().id}).done(function(){abp.notify.info(app.localize("ResetSuccessfully")),e.getModal().on("hidden.bs.modal",function(s){e.reopen()}),e.close()}).always(function(){e.setBusy(!1)})})},this.save=function(){e.setBusy(!0),i.updateUserPermissions({id:e.getArgs().id,grantedPermissionNames:s.getSelectedPermissionNames()}).done(function(){abp.notify.info(app.localize("SavedSuccessfully")),e.close()}).always(function(){e.setBusy(!1)})}};
$(function(){var e=$("#UsersTable"),a=abp.services.app.user,s=$("#NumberOfFilteredPermission"),t=[],r=app.modals.PermissionTreeModal.create({onSelectionDone:function(e){t=e;var a=e.length;s.text(a),abp.notify.success(app.localize("XCountPermissionFiltered",a)),d()}}),n={create:abp.auth.hasPermission("Pages.Administration.Users.Create"),edit:abp.auth.hasPermission("Pages.Administration.Users.Edit"),changePermissions:abp.auth.hasPermission("Pages.Administration.Users.ChangePermissions"),impersonation:abp.auth.hasPermission("Pages.Administration.Users.Impersonation"),unlock:abp.auth.hasPermission("Pages.Administration.Users.Unlock"),delete:abp.auth.hasPermission("Pages.Administration.Users.Delete")},i=new app.ModalManager({viewUrl:abp.appPath+"App/Users/CreateOrEditModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/Users/_CreateOrEditModal.js",modalClass:"CreateOrEditUserModal"}),o=new app.ModalManager({viewUrl:abp.appPath+"App/Users/PermissionsModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/Users/_PermissionsModal.js",modalClass:"UserPermissionsModal"}),l=e.DataTable({paging:!0,serverSide:!0,processing:!0,listAction:{ajaxFunction:a.getUsers,inputFilter:function(){return{filter:$("#UsersTableFilter").val(),permissions:t,role:$("#RoleSelectionCombo").val(),onlyLockedUsers:$("#UsersTable_OnlyLockedUsers").is(":checked")}}},columnDefs:[{className:"control responsive",orderable:!1,render:function(){return""},targets:0},{targets:1,data:null,orderable:!1,autoWidth:!1,defaultContent:"",rowAction:{text:'<i class="fa fa-cog"></i> '+app.localize("Actions")+' <span class="caret"></span>',items:[{text:app.localize("LoginAsThisUser"),visible:function(e){return n.impersonation&&e.record.id!==abp.session.userId},action:function(e){abp.ajax({url:abp.appPath+"Account/Impersonate",data:JSON.stringify({tenantId:abp.session.tenantId,userId:e.record.id})})}},{text:app.localize("Edit"),visible:function(){return n.edit},action:function(e){i.open({id:e.record.id})}},{text:app.localize("Permissions"),visible:function(){return n.changePermissions},action:function(e){o.open({id:e.record.id})}},{text:app.localize("Unlock"),visible:function(){return n.unlock},action:function(e){a.unlockUser({id:e.record.id}).done(function(){abp.notify.success(app.localize("UnlockedTheUser",e.record.userName))})}},{text:app.localize("Delete"),visible:function(){return n.delete},action:function(e){var s;(s=e.record).userName!==app.consts.userManagement.defaultAdminUserName?abp.message.confirm(app.localize("UserDeleteWarningMessage",s.userName),app.localize("AreYouSure"),function(e){e&&a.deleteUser({id:s.id}).done(function(){d(),abp.notify.success(app.localize("SuccessfullyDeleted"))})}):abp.message.warn(app.localize("{0}UserCannotBeDeleted",app.consts.userManagement.defaultAdminUserName))}}]}},{targets:2,data:"userName",render:function(e,a,s,t){var r=$("<span/>");if(s.profilePictureId){var n="/Profile/GetProfilePictureById?id="+s.profilePictureId,i=$("<a/>").attr("href",n).attr("target","_blank"),o=$("<img/>").addClass("img-circle").attr("src",n);i.append(o),r.append(i)}return r.append(e),r[0].outerHTML}},{targets:3,data:"name"},{targets:4,data:"surname"},{targets:5,data:"roles",orderable:!1,render:function(e){for(var a="",s=0;s<e.length;s++)a.length&&(a+=", "),a+=e[s].roleName;return a}},{targets:6,data:"emailAddress"},{targets:7,data:"isEmailConfirmed",render:function(e){var a=$("<span/>").addClass("label");return e?a.addClass("kt-badge kt-badge--success kt-badge--inline").text(app.localize("Yes")):a.addClass("kt-badge kt-badge--dark kt-badge--inline").text(app.localize("No")),a[0].outerHTML}},{targets:8,data:"isActive",render:function(e){var a=$("<span/>").addClass("label");return e?a.addClass("kt-badge kt-badge--success kt-badge--inline").text(app.localize("Yes")):a.addClass("kt-badge kt-badge--dark kt-badge--inline").text(app.localize("No")),a[0].outerHTML}},{targets:9,data:"creationTime",render:function(e){return moment(e).format("L")}}]});function d(){l.ajax.reload()}$("#ShowAdvancedFiltersSpan").click(function(){$("#ShowAdvancedFiltersSpan").hide(),$("#HideAdvancedFiltersSpan").show(),$("#AdvacedAuditFiltersArea").slideDown()}),$("#HideAdvancedFiltersSpan").click(function(){$("#HideAdvancedFiltersSpan").hide(),$("#ShowAdvancedFiltersSpan").show(),$("#AdvacedAuditFiltersArea").slideUp()}),$("#CreateNewUserButton").click(function(){i.open()});var c=function(){if(l.ajax.params().order.length>0){var e=l.ajax.params().order[0].column,a=l.ajax.params().order[0].dir;return l.ajax.params().columns[e].data+" "+a}return""};$("#ExportUsersToExcelButton").click(function(e){e.preventDefault(),a.getUsersToExcel({filter:$("#UsersTableFilter").val(),permissions:t,role:$("#RoleSelectionCombo").val(),onlyLockedUsers:$("#UsersTable_OnlyLockedUsers").is(":checked"),sorting:c()}).done(function(e){app.downloadTempFile(e)})}),$("#GetUsersButton, #RefreshUserListButton").click(function(e){e.preventDefault(),d()}),$("#UsersTableFilter").on("keydown",function(e){13===e.keyCode&&(e.preventDefault(),d())}),abp.event.on("app.createOrEditUserModalSaved",function(){d()}),$("#UsersTableFilter").focus(),$("#ImportUsersFromExcelButton").fileupload({url:abp.appPath+"Users/ImportFromExcel",dataType:"json",maxFileSize:104857600,done:function(e,a){a.result.success?abp.notify.info(app.localize("ImportUsersProcessStart")):abp.notify.warn(app.localize("ImportUsersUploadFailed"))}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled"),$("#FilterByPermissionsButton").click(function(){r.open({grantedPermissionNames:t})})});