var chatService=abp.services.app.chat,friendshipService=abp.services.app.friendship,chat={friends:[],tenantToTenantChatAllowed:abp.features.isEnabled("App.ChatFeature.TenantToTenant"),tenantToHostChatAllowed:abp.features.isEnabled("App.ChatFeature.TenantToHost"),serverClientTimeDifference:0,selectedUser:null,isOpen:!1,getFriendOrNull:function(e,t){var a=_.where(chat.friends,{friendUserId:parseInt(e),friendTenantId:t?parseInt(t):null});return a.length?a[0]:null},getFixedMessageTime:function(e){return moment(e).add(-1*chat.serverClientTimeDifference,"seconds").format("YYYY-MM-DDTHH:mm:ssZ")},getFriendsAndSettings:function(e){chatService.getUserChatFriendsWithSettings().done(function(t){chat.friends=t.friends,chat.serverClientTimeDifference=app.calculateTimeDifference(abp.clock.now(),t.serverTime,"seconds"),chat.triggerUnreadMessageCountChangeEvent(),chat.renderFriendLists(chat.friends),e()})},loadLastState:function(){app.localStorage.getItem("app.chat.isOpen",function(e){chat.isOpen=e,chat.adjustNotifyPosition(),app.localStorage.getItem("app.chat.pinned",function(e){chat.pinned=e,$("a.page-quick-sidebar-pinner").find("i:eq(0)").attr("class","fa fa-map-pin "+(chat.pinned?"":"fa-rotate-90"))}),chat.isOpen&&$("body, #kt_quick_sidebar").addClass("kt-quick-panel--on").promise().done(function(){$("#kt_quick_sidebar .kt-quick-panel__content").removeClass("kt-hide"),app.localStorage.getItem("app.chat.selectedUser",function(e){e?(chat.showMessagesPanel(),chat.selectFriend(e.friendUserId,e.friendTenantId)):chat.showFriendsPanel()})})})},changeChatPanelIsOpenOnLocalStorage:function(){app.localStorage.setItem("app.chat.isOpen",chat.isOpen)},changeChatUserOnLocalStorage:function(){app.localStorage.setItem("app.chat.selectedUser",chat.selectedUser)},changeChatPanelPinnedOnLocalStorage:function(){app.localStorage.setItem("app.chat.pinned",chat.pinned)},changeChatPanelPinned:function(e){chat.pinned=e,$(".page-quick-sidebar-pinner").find("i:eq(0)").attr("class","fa fa-map-pin "+(chat.pinned?"":"fa-rotate-90")),chat.changeChatPanelPinnedOnLocalStorage()},selectFriend:function(e,t){var a=chat.getFriendOrNull(e,t);if(chat.selectedUser=a,chat.changeChatUserOnLocalStorage(),chat.user.setSelectedUserOnlineStatus(a.isOnline),chat.showMessagesPanel(),chat.selectedUser.friendProfilePictureId){var s=chat.selectedUser.friendTenantId?chat.selectedUser.friendTenantId:"";$("#selectedChatUserImage").attr("src",abp.appPath+"Profile/GetFriendProfilePictureById?id="+chat.selectedUser.friendProfilePictureId+"&userId="+chat.selectedUser.friendUserId+"&tenantId="+s)}else $("#selectedChatUserImage").attr("src",abp.appPath+"Common/Images/default-profile-picture.png");if($("#selectedChatUserName").text(chat.user.getShownUserName(chat.selectedUser.friendTenancyName,chat.selectedUser.friendUserName)),$("#ChatMessage").val(""),chat.selectedUser.state!==app.consts.friendshipState.blocked?($("#liBanChatUser, #ChatMessageWrapper").show(),$("#liUnbanChatUser, #UnblockUserButton").hide(),$("#ChatMessage").removeAttr("disabled"),$("#ChatMessage").focus(),$("#SendChatMessageButton").removeAttr("disabled")):($("#liBanChatUser, #ChatMessageWrapper").hide(),$("#liUnbanChatUser, #UnblockUserButton").show(),$("#ChatMessage").attr("disabled","disabled"),$("#SendChatMessageButton").attr("disabled","disabled")),a.messagesLoaded){var n=chat.renderMessages(a.messages);$("#UserChatMessages").html(n),chat.scrollToBottom(),$(".timeago").timeago(),chat.user.markAllUnreadMessagesOfUserAsRead(chat.selectedUser)}else chat.user.loadMessages(a,function(){a.messagesLoaded=!0,chat.scrollToBottom()})},initConversationScrollbar:function(){var e=$("#kt_quick_sidebar").outerHeight(!0)-$(".kt-messenger-conversation .kt-portlet__head").outerHeight(!0)-$(".kt-messenger-conversation .kt-portlet__foot").outerHeight(!0)-75;$(".kt-messenger-conversation .kt-portlet__body").height(e+"px");var t=KTUtil.getByID("kt_quick_sidebar"),a=KTUtil.find(t,".kt-messenger-conversation .kt-portlet__body");KTUtil.scrollInit(a,{mobileNativeScroll:!0,desktopNativeScroll:!1,resetHeightOnDestroy:!0,handleWindowResize:!0,rememberPosition:!0,height:function(){var e,a=KTUtil.find(t,".kt-portlet > .kt-portlet__body"),s=KTUtil.find(t,".kt-widget.kt-widget--users"),n=KTUtil.find(t,".kt-searchbar");return e=KTUtil.isInResponsiveRange("desktop")?KTLayout.getContentHeight():KTUtil.getViewPort().height,t&&(e=(e=e-parseInt(KTUtil.css(t,"margin-top"))-parseInt(KTUtil.css(t,"margin-bottom")))-parseInt(KTUtil.css(t,"padding-top"))-parseInt(KTUtil.css(t,"padding-bottom"))),s&&(e=(e=e-parseInt(KTUtil.css(s,"margin-top"))-parseInt(KTUtil.css(s,"margin-bottom")))-parseInt(KTUtil.css(s,"padding-top"))-parseInt(KTUtil.css(s,"padding-bottom"))),a&&(e=(e=e-parseInt(KTUtil.css(a,"margin-top"))-parseInt(KTUtil.css(a,"margin-bottom")))-parseInt(KTUtil.css(a,"padding-top"))-parseInt(KTUtil.css(a,"padding-bottom"))),n&&(e=(e-=parseInt(KTUtil.css(n,"height")))-parseInt(KTUtil.css(n,"margin-top"))-parseInt(KTUtil.css(n,"margin-bottom"))),e-=5}}),a.addEventListener("ps-scroll-y",function(){a.scrollTop>0||chat.selectedUser.allPreviousMessagesLoaded||chat.user.loadMessages(chat.selectedUser)})},showMessagesPanel:function(){$(".kt-messenger-friends").hide(),$(".kt-messenger-conversation").show(function(){chat.initConversationScrollbar(),chat.scrollToBottom()}),$("#kt_quick_sidebar_back").removeClass("d-none")},showFriendsPanel:function(){$(".kt-messenger-friends").show(),$(".kt-messenger-conversation").hide(),$("#kt_quick_sidebar_back").addClass("d-none")},changeFriendState:function(e,t){var a=chat.getFriendOrNull(e.friendUserId,e.friendTenantId);a&&(a.state=t,chat.renderFriendLists(chat.friends))},getFormattedFriends:function(e){return $.each(e,function(e,t){t.profilePicturePath=chat.getFriendProfilePicturePath(t),t.shownUserName=chat.user.getShownUserName(t.friendTenancyName,t.friendUserName)}),e},renderFriendList:function(e,t){var a=$("#UserFriendTemplate").html();Mustache.parse(a);var s=Mustache.render(a,e);t.html(s)},renderFriendLists:function(e){e=chat.getFormattedFriends(e);var t=_.where(e,{state:app.consts.friendshipState.accepted});chat.renderFriendList(t,$("#friendListFriends"));var a=_.where(e,{state:app.consts.friendshipState.blocked});chat.renderFriendList(a,$("#friendListBlockeds")),t.length?$("#EmptyFriendListInfo").hide():$("#EmptyFriendListInfo").show(),a.length?$("#EmptyBlockedFriendListInfo").hide():$("#EmptyBlockedFriendListInfo").show()},getFriendProfilePicturePath:function(e){if(!e.friendProfilePictureId)return abp.appPath+"Common/Images/default-profile-picture.png";var t=e.friendTenantId?e.friendTenantId:"";return abp.appPath+"Profile/GetFriendProfilePictureById?id="+e.friendProfilePictureId+"&userId="+e.friendUserId+"&tenantId="+t},sendMessage:function(){$("form[name='chatMessageForm']").valid()&&chat.selectedUser.state!==app.consts.friendshipState.blocked&&($("#SendChatMessageButton").attr("disabled","disabled"),app.chat.sendMessage({tenantId:chat.selectedUser.friendTenantId,userId:chat.selectedUser.friendUserId,message:$("#ChatMessage").val(),tenancyName:app.session.tenant?app.session.tenant.tenancyName:null,userName:app.session.user.userName,profilePictureId:app.session.user.profilePictureId},function(){$("#ChatMessage").val(""),$("#SendChatMessageButton").removeAttr("disabled")}))},getFormattedMessages:function(e){return $.each(e,function(e,t){t.creationTime=chat.getFixedMessageTime(t.creationTime),t.cssClass=t.side===app.chat.side.sender?"kt-chat__message--right kt-bg-light-brand":"kt-bg-light-success",t.isIn=t.side!==app.chat.side.sender,t.shownUserName=t.side===app.chat.side.sender?app.session.user.userName:chat.selectedUser.friendUserName,t.profilePicturePath=t.side===app.chat.side.sender?app.session.user.profilePictureId?abp.appPath+"Profile/GetProfilePictureById?id="+app.session.user.profilePictureId:abp.appPath+"Common/Images/default-profile-picture.png":chat.getFriendProfilePicturePath(chat.selectedUser);var a=t.receiverReadState===app.chat.readState.read?" kt--font-info":" text-muted";if(t.readStateCheck=t.side===app.chat.side.sender?'<i class="read-state-check fa fa-check'+a+'" aria-hidden="true"></i>':"",t.message.startsWith("[image]")){var s=JSON.parse(t.message.substring("[image]".length)),n=abp.appPath+"App/Chat/GetImage?id="+t.id+"&contentType="+s.contentType,r='<a href="'+n+'" target="_blank"><img src="'+n+'" class="chat-image-preview"></a>';t.formattedMessage=r}else if(t.message.startsWith("[file]")){var i=JSON.parse(t.message.substring("[file]".length)),d='<a href="'+(abp.appPath+"App/Chat/GetFile?id="+t.id+"&contentType="+i.contentType)+'" target="_blank" class="chat-file-preview"><i class="la la-file"></i> '+i.name+' <i class="la la-download pull-right"></i></a>';t.formattedMessage=d}else if(t.message.startsWith("[link]")){var c=JSON.parse(t.message.substring("[file]".length));t.formattedMessage='<a href="'+c.message+'" target="_blank" class="chat-link-message"><i class="fa fa-link"></i> '+c.message+"</a>"}else t.formattedMessage=Mustache.escape(t.message)}),e},renderMessages:function(e){e=chat.getFormattedMessages(e);var t=$("#UserChatMessageTemplate").html();return Mustache.parse(t),Mustache.render(t,e)},scrollToBottom:function(){var e=$(".kt-messenger-conversation .kt-messenger__messages").prop("scrollHeight")+"px";$(".kt-messenger-conversation .kt-messenger__messages").slimScroll({scrollTo:e})},adjustNotifyPosition:function(){chat.isOpen?app.changeNotifyPosition("toast-chat-open"):app.changeNotifyPosition("toast-bottom-right")},triggerUnreadMessageCountChangeEvent:function(){var e=0;chat&&chat.friends&&(e=_.reduce(chat.friends,function(e,t){return e+t.unreadMessageCount},0)),abp.event.trigger("app.chat.unreadMessageCountChanged",e)},bindUiEvents:function(){new KTOffcanvas("kt_quick_sidebar",{baseClass:"kt-quick-panel",closeBy:"kt_quick_sidebar_close",toggleBy:"kt_quick_sidebar_toggle"}),$("#kt_quick_sidebar").on("click","#kt_quick_sidebar_back",function(){chat.selectedUser=null,chat.changeChatUserOnLocalStorage()}),$("#kt_quick_sidebar_toggle").on("click",function(){chat.isOpen=$("body").hasClass("kt-quick-panel--on"),chat.adjustNotifyPosition(),chat.changeChatPanelIsOpenOnLocalStorage(),chat.user.markAllUnreadMessagesOfUserAsRead(chat.selectedUser)}),$("#friendListFriends,#friendListBlockeds").on("click",".kt-widget__item",function(){var e=$(this).attr("data-friend-user-id"),t=$(this).attr("data-friend-tenant-id");chat.selectFriend(e,t)}),$("#kt_quick_sidebar_back").on("click",function(){chat.showFriendsPanel()}),$("#liBanChatUser a").click(function(){chat.user.block(chat.selectedUser)}),$("#liUnbanChatUser, #UnblockUserButton").click(function(){chat.user.unblock(chat.selectedUser)}),$(window).on("resize",function(){chat.initConversationScrollbar()}),$("#SearchChatUserButton").click(function(){chat.user.search()}),$("#ChatUserSearchUserName, #ChatUserSearchTenancyName").keypress(function(e){13===e.which&&chat.user.search()}),$("#ChatMessage").keypress(function(e){13===e.which&&(e.preventDefault(),chat.sendMessage())}),$("#SendChatMessageButton").click(function(e){chat.sendMessage()}),$("#ChatUserSearchUserName").on("keyup",function(){var e=$(this).val();e?$("#SearchChatUserButton").removeClass("d-none"):$("#SearchChatUserButton").addClass("d-none");var t=_.filter(chat.friends,function(t){return chat.user.getShownUserName(t.friendTenancyName,t.friendUserName).toLowerCase().indexOf(e.toLowerCase())>=0});chat.renderFriendLists(t)}),$("div.kt-quick-panel").on("mouseleave",function(e){chat.pinned||"m-popover"===$(e.target).attr("data-toggle")||($("body, #kt_quick_sidebar").removeClass("kt-quick-panel--on"),new KTOffcanvas("kt_quick_sidebar").hide(),chat.isOpen=!1,chat.adjustNotifyPosition(),chat.changeChatPanelIsOpenOnLocalStorage())}),$("form[name='chatMessageForm']").validate({invalidHandler:function(){$("#SendChatMessageButton").attr("disabled","disabled")},errorPlacement:function(){},success:function(){$("#SendChatMessageButton").removeAttr("disabled")}}),$(".page-quick-sidebar-pinner").click(function(){chat.changeChatPanelPinned(!chat.pinned)}),!chat.tenantToTenantChatAllowed&&chat.tenantToHostChatAllowed&&$("#InterTenantChatHintIcon").hide()},registerEvents:function(){abp.event.on("app.chat.messageReceived",function(e){var t=chat.getFriendOrNull(e.targetUserId,e.targetTenantId);if(t){if(t.messages=t.messages||[],t.messages.push(e),e.side===app.chat.side.receiver&&(t.unreadMessageCount+=1,e.readState=app.chat.readState.unread,chat.user.changeUnreadMessageCount(t.friendTenantId,t.friendUserId,t.unreadMessageCount),chat.triggerUnreadMessageCountChangeEvent(),chat.isOpen&&null!==chat.selectedUser&&t.friendTenantId===chat.selectedUser.friendTenantId&&t.friendUserId===chat.selectedUser.friendUserId?chat.user.markAllUnreadMessagesOfUserAsRead(chat.selectedUser):abp.notify.info(abp.utils.formatString("{0}: {1}",t.friendUserName,abp.utils.truncateString(e.message,100)),null,{onclick:function(){$("body").hasClass("kt-quick-panel--on")||($("body").addClass("kt-quick-panel--on"),chat.isOpen=!0,chat.changeChatPanelIsOpenOnLocalStorage()),chat.showMessagesPanel(),chat.selectFriend(t.friendUserId,t.friendTenantId),chat.changeChatPanelPinned(!0)}})),null!==chat.selectedUser&&t.friendUserId===chat.selectedUser.friendUserId&&t.friendTenantId===chat.selectedUser.friendTenantId){var a=chat.renderMessages([e]);$("#UserChatMessages").append(a),$(".timeago").timeago()}chat.scrollToBottom()}}),abp.event.on("app.chat.friendshipRequestReceived",function(e,t){t||abp.notify.info(abp.utils.formatString(app.localize("UserSendYouAFriendshipRequest"),e.friendUserName)),_.where(chat.friends,{userId:e.friendUserId,tenantId:e.friendTenantId}).length||(chat.friends.push(e),chat.renderFriendLists(chat.friends))}),abp.event.on("app.chat.userConnectionStateChanged",function(e){chat.user.setFriendOnlineStatus(e.friend.userId,e.friend.tenantId,e.isConnected)}),abp.event.on("app.chat.userStateChanged",function(e){var t=chat.getFriendOrNull(e.friend.userId,e.friend.tenantId);t&&(t.state=e.state,chat.renderFriendLists(chat.friends))}),abp.event.on("app.chat.allUnreadMessagesOfUserRead",function(e){var t=chat.getFriendOrNull(e.friend.userId,e.friend.tenantId);t&&(t.unreadMessageCount=0,chat.user.changeUnreadMessageCount(t.friendTenantId,t.friendUserId,t.unreadMessageCount),chat.triggerUnreadMessageCountChangeEvent())}),abp.event.on("app.chat.readStateChange",function(e){var t=chat.getFriendOrNull(e.friend.userId,e.friend.tenantId);t&&($.each(t.messages,function(e,t){t.receiverReadState=app.chat.readState.read}),chat.selectedUser&&chat.selectedUser.friendUserId===e.friend.userId&&$(".read-state-check").not(".m--font-info").addClass("m--font-info"))}),abp.event.on("app.chat.connected",function(){$("#chat_is_connecting_icon").hide(),$("#kt_quick_sidebar_toggle").removeClass("d-none"),chat.getFriendsAndSettings(function(){chat.bindUiEvents(),chat.loadLastState()})})},init:function(){chat.registerEvents(),chat.interTenantChatAllowed=abp.features.isEnabled("App.ChatFeature.TenantToTenant")||abp.features.isEnabled("App.ChatFeature.TenantToHost")||!app.session.tenant},user:{loadingPreviousUserMessages:!1,userNameFilter:"",getShownUserName:function(e,t){return(e||".")+"\\"+t},block:function(e){friendshipService.blockUser({userId:e.friendUserId,tenantId:e.friendTenantId}).done(function(){chat.changeFriendState(e,app.consts.friendshipState.blocked),abp.notify.info(app.localize("UserBlocked")),$("#ChatMessage").attr("disabled","disabled"),$("#SendChatMessageButton").attr("disabled","disabled"),$("#liBanChatUser, #ChatMessageWrapper").hide(),$("#liUnbanChatUser, #UnblockUserButton").show()})},unblock:function(e){friendshipService.unblockUser({userId:e.friendUserId,tenantId:e.friendTenantId}).done(function(){chat.changeFriendState(e,app.consts.friendshipState.accepted),abp.notify.info(app.localize("UserUnblocked")),$("#ChatMessage").removeAttr("disabled"),$("#ChatMessage").focus(),$("#SendChatMessageButton").removeAttr("disabled"),$("#liBanChatUser, #ChatMessageWrapper").show(),$("#liUnbanChatUser, #UnblockUserButton").hide()})},markAllUnreadMessagesOfUserAsRead:function(e){if(e&&chat.isOpen){var t=_.where(e.messages,{readState:app.chat.readState.unread}),a=_.pluck(t,"id");a.length&&chatService.markAllUnreadMessagesOfUserAsRead({tenantId:e.friendTenantId,userId:e.friendUserId}).done(function(){$.each(e.messages,function(e,t){a.indexOf(t.id)>=0&&(t.readState=app.chat.readState.read)})})}},changeUnreadMessageCount:function(e,t,a){e||(e="");var s=$('#friendListFriends div.kt-widget__item[data-friend-tenant-id="'+e+'"][data-friend-user-id="'+t+'"]');if(s){var n=$(s[0]).find("span.kt-badge");n.html(a),a?n.removeClass("d-none"):n.addClass("d-none")}},loadMessages:function(e,t){chat.user.loadingPreviousUserMessages=!0;var a=null;e.messages&&e.messages.length&&(a=_.min(e.messages,function(e){return e.id}).id),chatService.getUserChatMessages({minMessageId:a,tenantId:e.friendTenantId,userId:e.friendUserId}).done(function(a){e.messages||(e.messages=[]),e.messages=a.items.concat(e.messages),chat.user.markAllUnreadMessagesOfUserAsRead(e),a.items.length||(e.allPreviousMessagesLoaded=!0);var s=chat.renderMessages(e.messages);$("#UserChatMessages").html(s),$(".timeago").timeago(),chat.user.loadingPreviousUserMessages=!1,t&&t()})},openSearchModal:function(e){app.modals.LookupModal.create({title:app.localize("SelectAUser"),serviceMethod:abp.services.app.commonLookup.findUsers,filterText:$("#ChatUserSearchUserName").val(),extraFilters:{tenantId:e}}).open({},function(e){var t=e.value;friendshipService.createFriendshipRequest({userId:t,tenantId:null!==app.session.tenant?app.session.tenant.id:null}).done(function(){$("#ChatUserSearchUserName").val("")})})},search:function(){var e=$("#ChatUserSearchUserName").val(),t="",a="";if(-1===e.indexOf("\\"))a=e;else{var s=e.split("\\");t=s[0],a=s[1]}t&&chat.interTenantChatAllowed?friendshipService.createFriendshipRequestByUserName({tenancyName:t,userName:a}).done(function(){$("#ChatUserSearchUserName").val("")}):chat.user.openSearchModal(app.session.tenant?app.session.tenant.id:null,a)},setFriendOnlineStatus:function(e,t,a){var s=chat.getFriendOrNull(e,t);if(s){s.isOnline=a;var n="kt-badge kt-badge--dot kt-badge--"+(a?"online":"offline"),r=$('#friendListFriends div.kt-widget__item[data-friend-tenant-id="'+(t||"")+'"][data-friend-user-id="'+e+'"]');r&&$(r[0]).find(".kt-badge--dot").attr("class",n),chat.selectedUser&&t===chat.selectedUser.friendTenantId&&e===chat.selectedUser.friendUserId&&chat.user.setSelectedUserOnlineStatus(a)}},setSelectedUserOnlineStatus:function(e){if(chat.selectedUser){var t="kt-badge kt-badge--dot kt-badge--"+(e?"online":"offline");$("#selectedChatUserStatus span:eq(0)").attr("class",t),$("#selectedChatUserStatus small:eq(0)").text(app.localize(e?"Online":"Offline"))}}}};chat.init(),function(e){e(function(){var t=abp.appPath+"App/Chat/UploadFile";e("#chatImageUpload").fileupload({url:t,dataType:"json",maxFileSize:999e3,done:function(t,a){var s=a.result;e("#ChatMessage").val('[image]{"id":"'+s.result.id+'", "name":"'+s.result.name+'", "contentType":"'+s.result.contentType+'"}'),chat.sendMessage(),e(".chat-progress-bar").hide()},progressall:function(t,a){var s=parseInt(a.loaded/a.total*100,10);e(".chat-progress-bar").show(),e("#chatFileUploadProgress .progress-bar").css("width",s+"%")}}).prop("disabled",!e.support.fileInput).parent().addClass(e.support.fileInput?void 0:"disabled"),e("#chatFileUpload").fileupload({url:t,dataType:"json",maxFileSize:999e3,done:function(t,a){var s=a.result;e("#ChatMessage").val('[file]{"id":"'+s.result.id+'", "name":"'+s.result.name+'", "contentType":"'+s.result.contentType+'"}'),chat.sendMessage(),e(".chat-progress-bar").hide()},progressall:function(t,a){var s=parseInt(a.loaded/a.total*100,10);e(".chat-progress-bar").show(),e("#chatFileUploadProgress .progress-bar").css("width",s+"%")}}).prop("disabled",!e.support.fileInput).parent().addClass(e.support.fileInput?void 0:"disabled"),e("#btnLinkShare").click(function(){e("#chatDropdownToggle").dropdown("toggle"),e("#ChatMessage").val('[link]{"message":"'+window.location.href+'"}'),chat.sendMessage()}),e(".fileinput-button").click(function(){e("#chatDropdownToggle").dropdown("toggle")})})}(jQuery);