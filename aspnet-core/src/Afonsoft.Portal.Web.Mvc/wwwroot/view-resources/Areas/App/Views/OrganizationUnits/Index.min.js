$(function(){var e=abp.services.app.organizationUnit,t="Abp.Organizations.OrganizationUnit",n={manageOrganizationTree:abp.auth.hasPermission("Pages.Administration.OrganizationUnits.ManageOrganizationTree"),manageMembers:abp.auth.hasPermission("Pages.Administration.OrganizationUnits.ManageMembers"),manageRoles:abp.auth.hasPermission("Pages.Administration.OrganizationUnits.ManageRoles")},a=new app.ModalManager({viewUrl:abp.appPath+"App/OrganizationUnits/CreateModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/OrganizationUnits/_CreateModal.js",modalClass:"CreateOrganizationUnitModal"}),i=new app.ModalManager({viewUrl:abp.appPath+"App/OrganizationUnits/EditModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/OrganizationUnits/_EditModal.js",modalClass:"EditOrganizationUnitModal"}),o=new app.ModalManager({viewUrl:abp.appPath+"App/OrganizationUnits/AddMemberModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/OrganizationUnits/_AddMemberModal.js",modalClass:"AddMemberModal",addMemberOptions:{title:app.localize("SelectAUser"),serviceMethod:e.findUsers}}),l=new app.ModalManager({viewUrl:abp.appPath+"App/OrganizationUnits/AddRoleModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/OrganizationUnits/_AddRoleModal.js",modalClass:"AddRoleModal",addRoleOptions:{title:app.localize("SelectARole"),serviceMethod:e.findRoles}}),r=app.modals.EntityTypeHistoryModal.create(),d={$tree:$("#OrganizationUnitEditTree"),$emptyInfo:$("#OrganizationUnitTreeEmptyInfo"),show:function(){d.$emptyInfo.hide(),d.$tree.show()},hide:function(){d.$emptyInfo.show(),d.$tree.hide()},unitCount:0,setUnitCount:function(e){d.unitCount=e,e?d.show():d.hide()},refreshUnitCount:function(){d.setUnitCount(d.$tree.jstree("get_json").length)},selectedOu:{id:null,displayName:null,code:null,set:function(e){e?(d.selectedOu.id=e.id,d.selectedOu.displayName=e.original.displayName,d.selectedOu.code=e.original.code):(d.selectedOu.id=null,d.selectedOu.displayName=null,d.selectedOu.code=null),s.load(),u.load()}},contextMenu:function(a){var o={editUnit:{label:app.localize("Edit"),icon:"la la-pencil",_disabled:!n.manageOrganizationTree,action:function(e){var t=$.jstree.reference(e.reference);i.open({id:a.id},function(e){a.original.displayName=e.displayName,t.rename_node(a,d.generateTextOnTree(e))})}},addSubUnit:{label:app.localize("AddSubUnit"),icon:"la la-plus",_disabled:!n.manageOrganizationTree,action:function(){d.addUnit(a.id)}},addMember:{label:app.localize("AddMember"),icon:"la la-user-plus",_disabled:!n.manageMembers,action:function(){s.openAddModal()}},addRole:{label:app.localize("AddRole"),icon:"la la-user-plus",_disabled:!n.manageRoles,action:function(){u.openAddModal()}},delete:{label:app.localize("Delete"),icon:"la la-remove",_disabled:!n.manageOrganizationTree,action:function(t){var n=$.jstree.reference(t.reference);abp.message.confirm(app.localize("OrganizationUnitDeleteWarningMessage",a.original.displayName),app.localize("AreYouSure"),function(t){t&&e.deleteOrganizationUnit({id:a.id}).done(function(){abp.notify.success(app.localize("SuccessfullyDeleted")),n.delete_node(a),d.refreshUnitCount()}).fail(function(e){setTimeout(function(){abp.message.error(e.message)},500)})})}}};return abp.custom.EntityHistory&&abp.custom.EntityHistory.IsEnabled&&1===_.filter(abp.custom.EntityHistory.EnabledEntities,function(e){return e===t}).length&&(o.history={label:app.localize("History"),icon:"la la-history",_disabled:!n.manageOrganizationTree,action:function(){r.open({entityTypeFullName:t,entityId:a.original.id,entityTypeDescription:a.original.displayName})}}),o},addUnit:function(e){var t=$.jstree.reference(d.$tree);a.open({parentId:e},function(n){t.create_node(e?t.get_node(e):"#",{id:n.id,parent:n.parentId?n.parentId:"#",code:n.code,displayName:n.displayName,memberCount:0,roleCount:0,text:d.generateTextOnTree(n),state:{opened:!0}}),d.refreshUnitCount()})},generateTextOnTree:function(e){var t=e.memberCount>0||e.roleCount?" ou-text-has-members":" ou-text-no-members";return'<span title="'+e.code+'" class="ou-text text-dark'+t+'" data-ou-id="'+e.id+'">'+app.htmlUtils.htmlEncodeText(e.displayName)+' <i class="fa fa-caret-down text-muted"></i>  <span style="font-size: .82em; opacity: .5;"><span class="ou-text-member-count ml-2">'+e.memberCount+" "+app.localize("Members")+' ,</span> <span class="ou-text-role-count ml-1">'+e.roleCount+" "+app.localize("Roles")+"</span></span></span>"},incrementMemberCount:function(e,t){var n=d.$tree.jstree("get_node",e);n.original.memberCount=n.original.memberCount+t,d.$tree.jstree("rename_node",n,d.generateTextOnTree(n.original))},incrementRoleCount:function(e,t){var n=d.$tree.jstree("get_node",e);n.original.roleCount=n.original.roleCount+t,d.$tree.jstree("rename_node",n,d.generateTextOnTree(n.original))},getTreeDataFromServer:function(t){e.getOrganizationUnits({}).done(function(e){var n=_.map(e.items,function(e){return{id:e.id,parent:e.parentId?e.parentId:"#",code:e.code,displayName:e.displayName,memberCount:e.memberCount,roleCount:e.roleCount,text:d.generateTextOnTree(e),state:{opened:!0}}});t(n)})},init:function(){d.getTreeDataFromServer(function(t){d.setUnitCount(t.length),d.$tree.on("changed.jstree",function(e,t){if(1!=t.selected.length)d.selectedOu.set(null);else{var n=t.instance.get_node(t.selected[0]);d.selectedOu.set(n)}}).on("move_node.jstree",function(t,n){var a=n.parent&&"#"!=n.parent?d.$tree.jstree("get_node",n.parent).original.displayName:app.localize("Root");abp.message.confirm(app.localize("OrganizationUnitMoveConfirmMessage",n.node.original.displayName,a),app.localize("AreYouSure"),function(t){t?e.moveOrganizationUnit({id:n.node.id,newParentId:"#"===n.parent?null:n.parent}).done(function(){abp.notify.success(app.localize("SuccessfullyMoved")),d.reload()}).fail(function(e){d.$tree.jstree("refresh"),setTimeout(function(){abp.message.error(e.message)},500)}):d.$tree.jstree("refresh")})}).jstree({core:{data:t,multiple:!1,check_callback:function(e,t,n,a,i){return!0}},types:{default:{icon:"fa fa-folder kt--font-warning"},file:{icon:"fa fa-file  kt--font-warning"}},contextmenu:{items:d.contextMenu},sort:function(e,t){return this.get_node(t).original.displayName<this.get_node(e).original.displayName?1:-1},plugins:["types","contextmenu","wholerow","sort","dnd"]}),$("#AddRootUnitButton").click(function(e){e.preventDefault(),d.addUnit(null)}),d.$tree.on("click",".ou-text .fa-caret-down",function(e){e.preventDefault();var t=$(this).closest(".ou-text").attr("data-ou-id");setTimeout(function(){d.$tree.jstree("show_contextmenu",t)},100)})})},reload:function(){d.getTreeDataFromServer(function(e){d.setUnitCount(e.length),d.$tree.jstree(!0).settings.core.data=e,d.$tree.jstree("refresh")})}},s={$table:$("#OuMembersTable"),$emptyInfo:$("#OuMembersEmptyInfo"),$addUserToOuButton:$("#AddUserToOuButton"),$selectedOuRightTitle:$("#SelectedOuRightTitle"),dataTable:null,showTable:function(){s.$emptyInfo.hide(),s.$table.show(),s.$addUserToOuButton.show(),s.$selectedOuRightTitle.text(d.selectedOu.displayName).show()},hideTable:function(){s.$selectedOuRightTitle.hide(),s.$addUserToOuButton.hide(),s.$table.hide(),s.$emptyInfo.show()},load:function(){d.selectedOu.id?(s.showTable(),this.dataTable.ajax.reload()):s.hideTable()},add:function(t){var n=d.selectedOu.id;if(n){var a=_.pluck(t,"value");e.addUsersToOrganizationUnit({organizationUnitId:n,userIds:a}).done(function(){abp.notify.success(app.localize("SuccessfullyAdded")),d.incrementMemberCount(n,a.length),s.load()})}},remove:function(t){var n=d.selectedOu.id;n&&abp.message.confirm(app.localize("RemoveUserFromOuWarningMessage",t.userName,d.selectedOu.displayName),app.localize("AreYouSure"),function(a){a&&e.removeUserFromOrganizationUnit({organizationUnitId:parseInt(n),userId:t.id}).done(function(){abp.notify.success(app.localize("SuccessfullyRemoved")),d.incrementMemberCount(n,-1),s.load()})})},openAddModal:function(){var e=d.selectedOu.id;e&&o.open({title:app.localize("SelectAUser"),organizationUnitId:e},function(e){s.add(e)})},init:function(){this.dataTable=s.$table.find(".organization-members-table").DataTable({paging:!0,serverSide:!0,processing:!0,deferLoading:0,responsive:!1,listAction:{ajaxFunction:e.getOrganizationUnitUsers,inputFilter:function(){return{id:d.selectedOu.id}}},columnDefs:[{targets:0,data:null,orderable:!1,defaultContent:"",className:"text-center",rowAction:{targets:0,data:null,orderable:!1,defaultContent:"",element:$("<button/>").addClass("btn btn-outline-danger btn-icon btn-sm").attr("title",app.localize("Delete")).append($("<i/>").addClass("la la-times")).click(function(){var e=$(this).data();s.remove(e)}),visible:function(){return n.manageMembers}}},{targets:1,data:"userName"},{targets:2,data:"addedTime",render:function(e){return moment(e).format("L")}}]}),$("#AddUserToOuButton").click(function(e){e.preventDefault(),s.openAddModal()}),s.hideTable()}},u={$table:$("#OuRolesTable"),$emptyInfo:$("#OuRolesEmptyInfo"),$addRoleToOuButton:$("#AddRoleToOuButton"),$selectedOuRightTitle:$("#SelectedOuRightTitle"),dataTable:null,showTable:function(){u.$emptyInfo.hide(),u.$table.show(),u.$addRoleToOuButton.show(),u.$selectedOuRightTitle.text(d.selectedOu.displayName).show()},hideTable:function(){u.$selectedOuRightTitle.hide(),u.$addRoleToOuButton.hide(),u.$table.hide(),u.$emptyInfo.show()},load:function(){d.selectedOu.id?(u.showTable(),this.dataTable.ajax.reload()):u.hideTable()},add:function(t){var n=d.selectedOu.id;if(n){var a=_.pluck(t,"value");e.addRolesToOrganizationUnit({organizationUnitId:n,roleIds:a}).done(function(){abp.notify.success(app.localize("SuccessfullyAdded")),d.incrementRoleCount(n,a.length),u.load()})}},remove:function(t){var n=d.selectedOu.id;n&&abp.message.confirm(app.localize("RemoveRoleFromOuWarningMessage",t.displayName,d.selectedOu.displayName),app.localize("AreYouSure"),function(a){a&&e.removeRoleFromOrganizationUnit({organizationUnitId:parseInt(n),roleId:t.id}).done(function(){abp.notify.success(app.localize("SuccessfullyRemoved")),d.incrementRoleCount(n,-1),u.load()})})},openAddModal:function(){var e=d.selectedOu.id;e&&l.open({title:app.localize("SelectARole"),organizationUnitId:e},function(e){u.add(e)})},init:function(){this.dataTable=u.$table.find(".organization-roles-table").DataTable({paging:!0,serverSide:!0,processing:!0,deferLoading:0,responsive:!1,listAction:{ajaxFunction:e.getOrganizationUnitRoles,inputFilter:function(){return{id:d.selectedOu.id}}},columnDefs:[{targets:0,data:null,orderable:!1,defaultContent:"",className:"text-center",rowAction:{targets:0,data:null,orderable:!1,defaultContent:"",element:$("<button/>").addClass("btn btn-outline-danger btn-icon btn-sm").attr("title",app.localize("Delete")).append($("<i/>").addClass("la la-times")).click(function(){var e=$(this).data();u.remove(e)}),visible:function(){return n.manageRoles}}},{targets:1,data:"displayName"},{targets:2,data:"addedTime",render:function(e){return moment(e).format("L")}}]}),$("#AddRoleToOuButton").click(function(e){e.preventDefault(),u.openAddModal()}),u.hideTable()}};s.init(),u.init(),d.init()});