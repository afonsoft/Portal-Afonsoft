var FeaturesTree=function(e){return function(){var t;return{init:function(a){function n(){t.find(".jstree-node").each(function(){var a=e(this),n=a.find(".jstree-anchor"),r=JSON.parse(a.attr("data-feature")),i=a.attr("data-feature-value");if(r&&r.inputType)if("CHECKBOX"==r.inputType.name);else if("SINGLE_LINE_STRING"==r.inputType.name){if(!a.find(".feature-tree-textbox").length){n.find(".jstree-checkbox").hide();var u="text";r.inputType.validator&&"NUMERIC"==r.inputType.validator.name&&(u="number");var o=e('<input class="feature-tree-textbox" type="'+u+'" />').val(i).on("change",function(){t.jstree(!0)._model.data[r.name].li_attr["data-feature-value"]=o.val()});"number"==u?(o.attr("min",r.inputType.validator.minValue),o.attr("max",r.inputType.validator.maxValue)):r.inputType.validator&&"STRING"==r.inputType.validator.name&&(r.inputType.validator.maxLength>0&&o.attr("maxlength",r.inputType.validator.maxLength),r.inputType.validator.minLength>0&&o.attr("required","required"),r.inputType.validator.regularExpression&&o.attr("pattern",r.inputType.validator.regularExpression)),o.on("input propertychange paste",function(){!function(e,t){if(!e||!e.inputType||!e.inputType.validator)return!0;var a=e.inputType.validator;if("STRING"==a.name){if(null==t||null==t)return a.allowNull;if("string"!=typeof t)return!1;if(a.minLength>0&&t.length<a.minLength)return!1;if(a.maxLength>0&&t.length>a.maxLength)return!1;if(a.regularExpression)return new RegExp(a.regularExpression).test(t)}else if("NUMERIC"==a.name){var n=parseInt(t);if(isNaN(n))return!1;var r=a.minValue;if(r>n)return!1;var i=a.maxValue;if(i>0&&n>i)return!1}return!0}(r,o.val())?o.addClass("feature-tree-textbox-invalid"):(a.attr("data-feature-value",o.val()),o.removeClass("feature-tree-textbox-invalid"))}),o.appendTo(a)}}else if("COMBOBOX"==r.inputType.name&&!a.find(".feature-tree-combobox").length){n.find(".jstree-checkbox").hide();var l=e('<select class="feature-tree-combobox" />');_.each(r.inputType.itemSource.items,function(t){e("<option></option>").attr("value",t.value).text(t.displayText).appendTo(l)}),l.val(i).on("change",function(){t.jstree(!0)._model.data[r.name].li_attr["data-feature-value"]=l.val()}).appendTo(a)}})}(t=a).on("ready.jstree",function(){n()}).on("redraw.jstree",function(){n()}).on("after_open.jstree",function(){n()}).on("create_node.jstree",function(){n()}).on("changed.jstree",function(a,n){var r;n.node&&(n.node.state.selected?(function e(a){t.jstree("select_node",a,!0);var n=t.jstree("get_parent",a);n&&e(n)}(t.jstree("get_parent",n.node)),r=e.makeArray(t.jstree("get_node",n.node).children),t.jstree("select_node",r)):(r=e.makeArray(t.jstree("get_node",n.node).children),t.jstree("deselect_node",r)))}).jstree({types:{default:{icon:"fa fa-folder kt--font-warning"},file:{icon:"fa fa-file kt--font-warning"}},checkbox:{keep_selected_style:!1,three_state:!1,cascade:""},plugins:["checkbox","types"]})},getFeatureValues:function(){var a=[];return e.each(t.jstree(!0)._model.data,function(e,t){if(t.li_attr){var n=JSON.parse(t.li_attr["data-feature"]);"CHECKBOX"==n.inputType.name?a.push({name:n.name,value:t.state.selected}):a.push({name:n.name,value:t.li_attr["data-feature-value"]})}}),a},isValid:function(){return t.find(".feature-tree-textbox-invalid").length<=0}}}}(jQuery);
!function(e){e.validator.addMethod("tenancyNameRegex",function(e,n,t){return t.test(e)},app.localize("TenantName_Regex_Description")),app.modals.CreateTenantModal=function(){var n,t=abp.services.app.tenant,a=null,i=new app.PasswordComplexityHelper;this.init=function(t){var r=(n=t).getModal();(a=r.find("form[name=TenantInformationsForm]")).validate({rules:{TenancyName:{tenancyNameRegex:new RegExp(a.find("input[name=TenancyName]").attr("regex"))}}});var s=r.find("input[name=AdminPassword],input[name=AdminPasswordRepeat]"),o=s.closest(".form-group");i.setPasswordComplexityRules(s,window.passwordComplexitySetting),e("#CreateTenant_SetRandomPassword").change(function(){e(this).is(":checked")?(o.slideUp("fast"),s.removeAttr("required")):(o.slideDown("fast"),s.attr("required","required"))});var d=r.find("input[name=ConnectionString]"),c=d.closest(".form-group");e("#CreateTenant_UseHostDb").change(function(){e(this).is(":checked")?(c.slideUp("fast"),d.removeAttr("required")):(c.slideDown("fast"),d.attr("required","required"))}),r.find(".date-time-picker").datetimepicker({locale:abp.localization.currentLanguage.name,format:"L"});var p=r.find("input[name=SubscriptionEndDateUtc]").parent("div"),l=r.find("#CreateTenant_IsUnlimited"),u=r.find("input[name=SubscriptionEndDateUtc]");function m(){l.is(":checked")?(p.slideUp("fast"),u.removeAttr("required")):(p.slideDown("fast"),u.attr("required","required"))}l.change(function(){m()});var f=r.find("#EditionId");f.change(function(){var n="True"===e("option:selected",this).attr("data-isfree");""===e("option:selected",this).val()||n?(r.find(".subscription-component").slideUp("fast"),n?l.prop("checked",!0):l.prop("checked",!1)):r.find(".subscription-component").slideDown("fast")}),m(),f.trigger("change")},this.save=function(){if(a.valid()){var i=a.serializeFormToObject();e("#CreateTenant_IsUnlimited").is(":visible")&&!e("#CreateTenant_IsUnlimited").is(":checked")?i.SubscriptionEndDateUtc=e(".date-time-picker").data("DateTimePicker").date().format("YYYY-MM-DDTHH:mm:ss")+"Z":i.SubscriptionEndDateUtc=null,i.SetRandomPassword&&(i.Password=null,i.AdminPassword=null),i.UseHostDb&&(i.ConnectionString=null),n.setBusy(!0),t.createTenant(i).done(function(){abp.notify.info(app.localize("SavedSuccessfully")),n.close(),abp.event.trigger("app.createTenantModalSaved")}).always(function(){n.setBusy(!1)})}}}}(jQuery);
var EditTenantModal=function(e){app.modals.EditTenantModal=function(){var t,i=abp.services.app.tenant,n=null;this.init=function(i){var a=(t=i).getModal();(n=a.find("form[name=TenantInformationsForm]")).validate(),a.find(".date-time-picker").datetimepicker({locale:abp.localization.currentLanguage.name,format:"L"});var s=a.find("input[name=SubscriptionEndDateUtc]").parent("div"),d=a.find("#CreateTenant_IsUnlimited");function o(){d.is(":checked")?s.slideUp("fast"):s.slideDown("fast")}d.change(function(){o()});var c=a.find("#EditionId"),r=a.find("#EditTenant_IsInTrialPeriod");c.change(function(){var t="True"===e("option:selected",this).attr("data-isfree"),i=e("option:selected",this).val();t?r.closest("div").slideUp("fast"):r.closest("div").slideDown("fast"),i<=0?(a.find(".subscription-component").slideUp("fast"),d.is(":checked")||s.slideDown("fast")):a.find(".subscription-component").slideDown("fast")}),c.trigger("change"),o()},this.save=function(){if(n.valid()){var a=n.serializeFormToObject();e("#CreateTenant_IsUnlimited").is(":visible")&&!e("#CreateTenant_IsUnlimited").is(":checked")?a.SubscriptionEndDateUtc=e(".date-time-picker").data("DateTimePicker").date().format("YYYY-MM-DDTHH:mm:ss")+"Z":a.SubscriptionEndDateUtc=null,t.setBusy(!0),i.updateTenant(a).done(function(){abp.notify.info(app.localize("SavedSuccessfully")),t.close(),abp.event.trigger("app.editTenantModalSaved")}).always(function(){t.setBusy(!1)})}}}}(jQuery);
app.modals.TenantFeaturesModal=function(){var e,t,a=abp.services.app.tenant;this.init=function(n){e=n,(t=new FeaturesTree).init(e.getModal().find(".feature-tree")),e.getModal().find("[data-toggle=tooltip]").tooltip(),e.getModal().find(".reset-features-button").click(function(){e.setBusy(!0),a.resetTenantSpecificFeatures({id:e.getArgs().id}).done(function(){abp.notify.info(app.localize("ResetSuccessfully")),e.getModal().on("hidden.bs.modal",function(t){e.reopen()}),e.close()}).always(function(){e.setBusy(!1)})})},this.save=function(){t.isValid()?(e.setBusy(!0),a.updateTenantFeatures({id:e.getArgs().id,featureValues:t.getFeatureValues()}).done(function(){abp.notify.info(app.localize("SavedSuccessfully")),e.close()}).always(function(){e.setBusy(!1)})):abp.message.warn(app.localize("InvalidFeaturesWarning"))}};
$(function(){var e=abp.services.app.tenant,t=$("#TenantsTable"),a=$("#TenantsTableFilter"),n=$("#TenantsFormFilter"),i=$("#TenantsTable_SubscriptionEndDateRangeActive"),r=n.find("input[name='SubscriptionEndDateRange']"),o=$("#TenantsTable_CreationDateRangeActive"),s=n.find("input[name='CreationDateRange']"),c=n.find("button[name='RefreshButton']"),p=n.find("#EditionDropdown"),d="Afonsoft.Portal.MultiTenancy.Tenant",l={create:abp.auth.hasPermission("Pages.Tenants.Create"),edit:abp.auth.hasPermission("Pages.Tenants.Edit"),changeFeatures:abp.auth.hasPermission("Pages.Tenants.ChangeFeatures"),impersonation:abp.auth.hasPermission("Pages.Tenants.Impersonation"),delete:abp.auth.hasPermission("Pages.Tenants.Delete")},u={creationDateStart:$.url("?creationDateStart"),creationDateEnd:$.url("?creationDateEnd"),subscriptionEndDateStart:$.url("?subscriptionEndDateStart"),subscriptionEndDateEnd:$.url("?subscriptionEndDateEnd")},b={startDate:u.subscriptionEndDateStart?moment(u.subscriptionEndDateStart):moment().startOf("day"),endDate:u.subscriptionEndDateEnd?moment(u.subscriptionEndDateEnd):moment().add(30,"days").endOf("day")},f={startDate:u.creationDateStart?moment(u.creationDateStart):moment().add(-7,"days").startOf("day"),endDate:u.creationDateEnd?moment(u.creationDateEnd):moment().endOf("day")};r.daterangepicker($.extend(!0,app.createDateRangePickerOptions({allowFutureDate:!0}),b),function(e,t,a){b.startDate=e,b.endDate=t}),s.daterangepicker($.extend(!0,app.createDateRangePickerOptions(),f),function(e,t,a){f.startDate=e,f.endDate=t});var m=new app.ModalManager({viewUrl:abp.appPath+"App/Tenants/CreateModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/Tenants/_CreateModal.js",modalClass:"CreateTenantModal"}),D=new app.ModalManager({viewUrl:abp.appPath+"App/Tenants/EditModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/Tenants/_EditModal.js",modalClass:"EditTenantModal"}),g=new app.ModalManager({viewUrl:abp.appPath+"App/Tenants/FeaturesModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/Tenants/_FeaturesModal.js",modalClass:"TenantFeaturesModal"}),T=app.modals.LookupModal.create({title:app.localize("SelectAUser"),serviceMethod:abp.services.app.commonLookup.findUsers}),E=app.modals.EntityTypeHistoryModal.create(),h=t.DataTable({paging:!0,serverSide:!0,processing:!0,listAction:{ajaxFunction:e.getTenants,inputFilter:function(){return e=p.find(":selected").val(),t={filter:a.val(),editionId:e,editionIdSpecified:"-1"!==e},o.prop("checked")&&(t.creationDateStart=f.startDate,t.creationDateEnd=f.endDate),i.prop("checked")&&(t.subscriptionEndDateStart=b.startDate,t.subscriptionEndDateEnd=b.endDate),t;var e,t}},columnDefs:[{className:"control responsive",orderable:!1,render:function(){return""},targets:0},{targets:1,data:null,orderable:!1,autoWidth:!1,defaultContent:"",rowAction:{text:'<i class="fa fa-cog"></i> '+app.localize("Actions")+' <span class="caret"></span>',items:[{text:app.localize("LoginAsThisTenant"),visible:function(){return l.impersonation},action:function(e){T.open({extraFilters:{tenantId:e.record.id},title:app.localize("SelectAUser")},function(t){abp.ajax({url:abp.appPath+"Account/Impersonate",data:JSON.stringify({tenantId:e.record.id,userId:parseInt(t.value)}),success:function(){app.supportsTenancyNameInUrl||abp.multiTenancy.setTenantIdCookie(e.record.id)}})})}},{text:app.localize("Edit"),visible:function(){return l.edit},action:function(e){D.open({id:e.record.id})}},{text:app.localize("Features"),visible:function(){return l.changeFeatures},action:function(e){g.open({id:e.record.id})}},{text:app.localize("Delete"),visible:function(){return l.delete},action:function(t){var a;a=t.record,abp.message.confirm(app.localize("TenantDeleteWarningMessage",a.tenancyName),app.localize("AreYouSure"),function(t){t&&e.deleteTenant({id:a.id}).done(function(){v(),abp.notify.success(app.localize("SuccessfullyDeleted"))})})}},{text:app.localize("Unlock"),action:function(t){e.unlockTenantAdmin({id:t.record.id}).done(function(){abp.notify.success(app.localize("UnlockedTenandAdmin",t.record.name))})}},{text:app.localize("History"),visible:function(){return abp.custom.EntityHistory&&abp.custom.EntityHistory.IsEnabled&&1===_.filter(abp.custom.EntityHistory.EnabledEntities,function(e){return e===d}).length},action:function(e){E.open({entityTypeFullName:d,entityId:e.record.id,entityTypeDescription:e.record.name})}}]}},{targets:2,data:"tenancyName"},{targets:3,data:"name"},{targets:4,data:"editionDisplayName"},{targets:5,data:"subscriptionEndDateUtc",render:function(e){return e?moment(e).format("L"):""}},{targets:6,data:"isActive",render:function(e){return e?'<span class="kt-badge kt-badge--success kt-badge--inline">'+app.localize("Yes")+"</span>":'<span class="kt-badge kt-badge--dark kt-badge--inline">'+app.localize("No")+"</span>"}},{targets:7,data:"creationTime",render:function(e){return moment(e).format("L")}}]});function v(){h.ajax.reload()}$("#CreateNewTenantButton").click(function(){m.open()}),$("#GetTenantsButton").click(function(e){e.preventDefault(),v()}),abp.event.on("app.editTenantModalSaved",function(){v()}),abp.event.on("app.createTenantModalSaved",function(){v()}),i.change(function(){r.prop("disabled",!$(this).prop("checked"))}),u.subscriptionEndDateStart||u.subscriptionEndDateEnd?i.prop("checked",!0):r.prop("disabled",!0),o.change(function(){s.prop("disabled",!$(this).prop("checked"))}),u.creationDateStart||u.creationDateEnd?o.prop("checked",!0):s.prop("disabled",!0),c.click(function(e){e.preventDefault(),v()}),a.focus()});