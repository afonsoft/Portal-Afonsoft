$(function(){var e=abp.services.app.tenant,t=$("#TenantsTable"),a=$("#TenantsTableFilter"),n=$("#TenantsFormFilter"),i=$("#TenantsTable_SubscriptionEndDateRangeActive"),r=n.find("input[name='SubscriptionEndDateRange']"),o=$("#TenantsTable_CreationDateRangeActive"),s=n.find("input[name='CreationDateRange']"),c=n.find("button[name='RefreshButton']"),p=n.find("#EditionDropdown"),d="Afonsoft.Portal.MultiTenancy.Tenant",l={create:abp.auth.hasPermission("Pages.Tenants.Create"),edit:abp.auth.hasPermission("Pages.Tenants.Edit"),changeFeatures:abp.auth.hasPermission("Pages.Tenants.ChangeFeatures"),impersonation:abp.auth.hasPermission("Pages.Tenants.Impersonation"),delete:abp.auth.hasPermission("Pages.Tenants.Delete")},u={creationDateStart:$.url("?creationDateStart"),creationDateEnd:$.url("?creationDateEnd"),subscriptionEndDateStart:$.url("?subscriptionEndDateStart"),subscriptionEndDateEnd:$.url("?subscriptionEndDateEnd")},b={startDate:u.subscriptionEndDateStart?moment(u.subscriptionEndDateStart):moment().startOf("day"),endDate:u.subscriptionEndDateEnd?moment(u.subscriptionEndDateEnd):moment().add(30,"days").endOf("day")},f={startDate:u.creationDateStart?moment(u.creationDateStart):moment().add(-7,"days").startOf("day"),endDate:u.creationDateEnd?moment(u.creationDateEnd):moment().endOf("day")};r.daterangepicker($.extend(!0,app.createDateRangePickerOptions({allowFutureDate:!0}),b),function(e,t,a){b.startDate=e,b.endDate=t}),s.daterangepicker($.extend(!0,app.createDateRangePickerOptions(),f),function(e,t,a){f.startDate=e,f.endDate=t});var m=new app.ModalManager({viewUrl:abp.appPath+"App/Tenants/CreateModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/Tenants/_CreateModal.js",modalClass:"CreateTenantModal"}),D=new app.ModalManager({viewUrl:abp.appPath+"App/Tenants/EditModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/Tenants/_EditModal.js",modalClass:"EditTenantModal"}),g=new app.ModalManager({viewUrl:abp.appPath+"App/Tenants/FeaturesModal",scriptUrl:abp.appPath+"view-resources/Areas/App/Views/Tenants/_FeaturesModal.js",modalClass:"TenantFeaturesModal"}),T=app.modals.LookupModal.create({title:app.localize("SelectAUser"),serviceMethod:abp.services.app.commonLookup.findUsers}),E=app.modals.EntityTypeHistoryModal.create(),h=t.DataTable({paging:!0,serverSide:!0,processing:!0,listAction:{ajaxFunction:e.getTenants,inputFilter:function(){return e=p.find(":selected").val(),t={filter:a.val(),editionId:e,editionIdSpecified:"-1"!==e},o.prop("checked")&&(t.creationDateStart=f.startDate,t.creationDateEnd=f.endDate),i.prop("checked")&&(t.subscriptionEndDateStart=b.startDate,t.subscriptionEndDateEnd=b.endDate),t;var e,t}},columnDefs:[{className:"control responsive",orderable:!1,render:function(){return""},targets:0},{targets:1,data:null,orderable:!1,autoWidth:!1,defaultContent:"",rowAction:{text:'<i class="fa fa-cog"></i> '+app.localize("Actions")+' <span class="caret"></span>',items:[{text:app.localize("LoginAsThisTenant"),visible:function(){return l.impersonation},action:function(e){T.open({extraFilters:{tenantId:e.record.id},title:app.localize("SelectAUser")},function(t){abp.ajax({url:abp.appPath+"Account/Impersonate",data:JSON.stringify({tenantId:e.record.id,userId:parseInt(t.value)}),success:function(){app.supportsTenancyNameInUrl||abp.multiTenancy.setTenantIdCookie(e.record.id)}})})}},{text:app.localize("Edit"),visible:function(){return l.edit},action:function(e){D.open({id:e.record.id})}},{text:app.localize("Features"),visible:function(){return l.changeFeatures},action:function(e){g.open({id:e.record.id})}},{text:app.localize("Delete"),visible:function(){return l.delete},action:function(t){var a;a=t.record,abp.message.confirm(app.localize("TenantDeleteWarningMessage",a.tenancyName),app.localize("AreYouSure"),function(t){t&&e.deleteTenant({id:a.id}).done(function(){v(),abp.notify.success(app.localize("SuccessfullyDeleted"))})})}},{text:app.localize("Unlock"),action:function(t){e.unlockTenantAdmin({id:t.record.id}).done(function(){abp.notify.success(app.localize("UnlockedTenandAdmin",t.record.name))})}},{text:app.localize("History"),visible:function(){return abp.custom.EntityHistory&&abp.custom.EntityHistory.IsEnabled&&1===_.filter(abp.custom.EntityHistory.EnabledEntities,function(e){return e===d}).length},action:function(e){E.open({entityTypeFullName:d,entityId:e.record.id,entityTypeDescription:e.record.name})}}]}},{targets:2,data:"tenancyName"},{targets:3,data:"name"},{targets:4,data:"editionDisplayName"},{targets:5,data:"subscriptionEndDateUtc",render:function(e){return e?moment(e).format("L"):""}},{targets:6,data:"isActive",render:function(e){return e?'<span class="kt-badge kt-badge--success kt-badge--inline">'+app.localize("Yes")+"</span>":'<span class="kt-badge kt-badge--dark kt-badge--inline">'+app.localize("No")+"</span>"}},{targets:7,data:"creationTime",render:function(e){return moment(e).format("L")}}]});function v(){h.ajax.reload()}$("#CreateNewTenantButton").click(function(){m.open()}),$("#GetTenantsButton").click(function(e){e.preventDefault(),v()}),abp.event.on("app.editTenantModalSaved",function(){v()}),abp.event.on("app.createTenantModalSaved",function(){v()}),i.change(function(){r.prop("disabled",!$(this).prop("checked"))}),u.subscriptionEndDateStart||u.subscriptionEndDateEnd?i.prop("checked",!0):r.prop("disabled",!0),o.change(function(){s.prop("disabled",!$(this).prop("checked"))}),u.creationDateStart||u.creationDateEnd?o.prop("checked",!0):s.prop("disabled",!0),c.click(function(e){e.preventDefault(),v()}),a.focus()});